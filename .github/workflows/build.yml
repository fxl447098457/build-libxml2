name: Build Minimal libxml2 v2.9.3 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'libxml-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  LIBXML_VERSION: 2.9.3

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_arch: i686
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z  
            cmake_generator: "MinGW Makefiles"
            artifact_name: libxml2-2.9.3-minimal-win32-gcc93-sjlj
            extra_flags: "CFLAGS=-m32 CXXFLAGS=-m32"
            gcc_prefix: i686-w64-mingw32
          - arch: x64
            msystem: MINGW64
            mingw_arch: x86_64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z  
            cmake_generator: "MinGW Makefiles"
            artifact_name: libxml2-2.9.3-minimal-win64-gcc93-sjlj
            extra_flags: ""
            gcc_prefix: x86_64-w64-mingw32

    name: Build Minimal ${{ matrix.arch }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup winlibs Toolchain
      shell: pwsh
      id: setup_toolchain
      run: |
        $url = "${{ matrix.toolchain_url }}"
        Write-Host "Downloading toolchain from: $url"
        
        $toolchainDir = "C:\winlibs"
        New-Item -ItemType Directory -Force -Path $toolchainDir | Out-Null
        
        Invoke-WebRequest -Uri $url -OutFile toolchain.7z
        7z x toolchain.7z -o"$toolchainDir" -y
        
        $mingwDir = if ("${{ matrix.arch }}" -eq "x86") { "mingw32" } else { "mingw64" }
        $gccPrefix = if ("${{ matrix.arch }}" -eq "x86") { "i686-w64-mingw32" } else { "x86_64-w64-mingw32" }
        $gccExe = Join-Path $toolchainDir "$mingwDir\bin\$gccPrefix-gcc.exe"
        
        if (-not (Test-Path $gccExe)) {
          Write-Error "GCC not found at expected path: $gccExe"
          Get-ChildItem -Path (Join-Path $toolchainDir $mingwDir) -Recurse -Filter "*.exe" | Select-Object -First 10
          exit 1
        }
        
        Write-Host "Found GCC at: $gccExe"
        
        $binPath = Join-Path $toolchainDir "$mingwDir\bin"
        Add-Content -Path $env:GITHUB_PATH -Value $binPath
        
        Add-Content -Path $env:GITHUB_OUTPUT -Value "winlibs_path=$binPath"
        Add-Content -Path $env:GITHUB_OUTPUT -Value "gcc_prefix=$gccPrefix"

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          make
          mingw-w64-${{ matrix.mingw_arch }}-cmake
          mingw-w64-${{ matrix.mingw_arch }}-ninja

    - name: Download libxml2 Source
      shell: msys2 {0}
      run: |
        curl -L -o libxml2.tar.gz "https://github.com/GNOME/libxml2/archive/refs/tags/v2.9.3.tar.gz"
        tar -xzf libxml2.tar.gz
        ls -la
        find . -maxdepth 2 -type d -name "libxml2*" | head -5

    - name: Configure and Build Minimal libxml2
      shell: msys2 {0}
      run: |
        export WINLIBS_BIN="${{ steps.setup_toolchain.outputs.winlibs_path }}"
        export GCC_PREFIX="${{ steps.setup_toolchain.outputs.gcc_prefix }}"
        
        WINLIBS_MSYS=$(cygpath -u "$WINLIBS_BIN")
        export PATH="$WINLIBS_MSYS:$PATH"
        
        echo "=== Compiler Check ==="
        which ${GCC_PREFIX}-gcc || { echo "GCC not found!"; exit 1; }
        which ar || { echo "AR not found!"; exit 1; }
        which ${GCC_PREFIX}-windres || { echo "windres not found!"; exit 1; }
        ${GCC_PREFIX}-gcc --version | head -2
        
        cd libxml2-2.9.2
        
        echo "=== Copying custom Makefile ==="
        cp ${{ github.workspace }}/.github/workflows/libxml2-minimal.mingw win32/Makefile.mingw
        
        cd win32
        
        export EXTRA_FLAGS="${{ matrix.extra_flags }} -DNDEBUG"
        export PREFIX=$(cygpath -u "$PWD/../install")
        
        echo "=== Building ==="
        make clean 2>/dev/null || true
        make -j$(nproc)
        
        echo "=== Build output ==="
        ls -lh *.a
        
        mkdir -p ../install/lib ../install/include/libxml
        cp libxml2.a ../install/lib/
        
        cd ..
        cp include/libxml/*.h install/include/libxml/
        
        rm -f install/include/libxml/nanoftp.h
        rm -f install/include/libxml/nanohttp.h
        rm -f install/include/libxml/catalog.h
        rm -f install/include/libxml/xpointer.h
        rm -f install/include/libxml/schemasInternals.h
        rm -f install/include/libxml/xmlschemas.h
        rm -f install/include/libxml/xmlschemastypes.h
        rm -f install/include/libxml/schematron.h
        rm -f install/include/libxml/relaxng.h
        rm -f install/include/libxml/xmlwriter.h
        rm -f install/include/libxml/c14n.h
        rm -f install/include/libxml/xinclude.h
        
        
        # æ–¹æ¡ˆBï¼šä¿ç•™ xmlreader.h å’Œ xpath.hï¼ˆxpath.h æä¾› xmlreader éœ€è¦çš„ç±»å‹ï¼‰
        # æ³¨æ„ï¼šä¸åˆ é™¤ xpath.h å’Œ xmlreader.h
        
        echo "=== Installed files (Scheme B) ==="
        find install -type f | head -20
        echo "=== Verifying Reader header exists ==="
        ls -la install/include/libxml/xmlreader.h || echo "ERROR: xmlreader.h missing!"
        ls -la install/include/libxml/xpath.h || echo "ERROR: xpath.h missing!"

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        New-Item -ItemType Directory -Force -Path "$pkgName\lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "$pkgName\include\libxml" | Out-Null
        
        # å¤åˆ¶åº“æ–‡ä»¶
        $libSource = "libxml2-2.9.3\install\lib"
        if (Test-Path $libSource) {
          Get-ChildItem -Path $libSource -Filter "*.a" | ForEach-Object {
            Copy-Item $_.FullName -Destination "$pkgName\lib\" -Force
          }
        }
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯• win32 ç›®å½•
        $altSource = "libxml2-2.9.3\win32"
        if (-not (Test-Path "$pkgName\lib\*.a")) {
          Get-ChildItem -Path $altSource -Filter "*.a" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName -Destination "$pkgName\lib\" -Force
          }
        }
        
        # å¤åˆ¶å¤´æ–‡ä»¶ï¼ˆæ–¹æ¡ˆBï¼šä¿ç•™ xmlreader.h å’Œ xpath.hï¼‰
        $includeSource = "libxml2-2.9.3\install\include"
        if (Test-Path $includeSource) {
          Copy-Item "$includeSource\*" -Destination "$pkgName\" -Recurse -Force
        } else {
          # ç›´æ¥ä»å¤´æ–‡ä»¶æºå¤åˆ¶ï¼Œä½†ä¿ç•™ xpath.h å’Œ xmlreader.h
          Copy-Item "libxml2-2.9.3\include\libxml\*.h" -Destination "$pkgName\include\libxml\" -Force
          # åˆ é™¤ç½‘ç»œç›¸å…³å¤´æ–‡ä»¶ï¼ˆä¸åˆ é™¤ xpath.h å’Œ xmlreader.hï¼‰
          $netHeaders = @("nanoftp.h", "nanohttp.h", "catalog.h", 
                         "schemasInternals.h", "xmlschemas.h", "xmlschemastypes.h",
                         "schematron.h", "relaxng.h", "xmlwriter.h", "c14n.h", "xinclude.h")
          foreach ($h in $netHeaders) {
            $path = "$pkgName\include\libxml\$h"
            if (Test-Path $path) { Remove-Item $path -Force }
          }
        }
        
        # åˆ›å»ºé…ç½®è¯´æ˜
        $configInfo = @"
        # Minimal libxml2 Configuration - Scheme B (Reader API Enabled)
        
        ## ç¼–è¯‘é€‰é¡¹
        - ç‰ˆæœ¬: 2.9.3
        - ç¼–è¯‘å™¨: MinGW-w64 GCC 9.3.0 (SJLJ)
        - æ¶æ„: ${{ matrix.arch }}
        
        ## ç¦ç”¨çš„åŠŸèƒ½ (èŠ‚çœç©ºé—´ï¼Œæé«˜å®‰å…¨æ€§)
        - âŒ HTTP/FTP ç½‘ç»œæ”¯æŒ (nanohttp, nanoftp)
        - âŒ XML Schemas/RelaxNG éªŒè¯
        - âŒ XInclude æ–‡ä»¶åŒ…å«
        - âŒ Canonical XML (C14N)
        - âŒ Catalog æ”¯æŒ
        - âŒ XML Writer
        - âŒ XPath è¡¨è¾¾å¼æ±‚å€¼ (ä¿ç•™å¤´æ–‡ä»¶ç±»å‹å®šä¹‰ï¼Œä½†æ— è¿è¡Œæ—¶åŠŸèƒ½)
        - âŒ XPointer
        - âŒ æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ
        - âŒ çº¿ç¨‹æ”¯æŒ
        - âŒ åŠ¨æ€æ¨¡å—åŠ è½½
        - âŒ Zlib/LZMA å‹ç¼©
        
        ## ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
        - âœ… XML/SAX2 è§£æ
        - âœ… DOM Tree æ“ä½œ
        - âœ… XmlTextReader (æµå¼æ¸¸æ ‡ API) - æ¨èç”¨äºå¤§æ–‡ä»¶
        - âœ… æœ¬åœ°æ–‡ä»¶ I/O
        - âœ… å­—ç¬¦ç¼–ç è½¬æ¢ (å†…ç½®)
        - âœ… HTML è§£æå™¨ (ç®€åŒ–ç‰ˆ)
        - âœ… åŸºç¡€ DTD éªŒè¯
        
        ## ä½¿ç”¨ç¤ºä¾‹ - Reader API (æ¨è)
        ```c
        #include <libxml/xmlreader.h>
        #define LIBXML_STATIC
        
        int main() {
            xmlTextReaderPtr reader = xmlReaderForFile("bigfile.xml", NULL, 0);
            if (reader) {
                while (xmlTextReaderRead(reader) == 1) {
                    int type = xmlTextReaderNodeType(reader);
                    const xmlChar *name = xmlTextReaderConstName(reader);
                    // å¤„ç†èŠ‚ç‚¹...
                }
                xmlFreeTextReader(reader);
            }
            xmlCleanupParser();
            return 0;
        }
        ```
        
        ## ä½¿ç”¨ç¤ºä¾‹ - DOM API (å°æ–‡ä»¶)
        ```c
        #include <libxml/parser.h>
        #include <libxml/tree.h>
        #define LIBXML_STATIC
        
        int main() {
            xmlDocPtr doc = xmlReadFile("config.xml", NULL, 0);
            if (doc) {
                xmlNodePtr root = xmlDocGetRootElement(doc);
                // éå† DOM æ ‘...
                xmlFreeDoc(doc);
            }
            xmlCleanupParser();
            return 0;
        }
        ```
        
        ## é“¾æ¥é€‰é¡¹
        `-lxml2 -lws2_32 -luser32`
        æˆ–é™æ€é“¾æ¥: `-L. -lxml2 -lws2_32 -luser32`
        "@
        
        $configInfo | Out-File -Encoding utf8 -FilePath "$pkgName\CONFIG.txt"
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯
        $buildInfo = "Minimal libxml2 ${{ env.LIBXML_VERSION }} ${{ matrix.arch }} (Reader API Enabled)`n" +
                     "Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)`n" +
                     "Toolchain: winlibs 9.3.0-7.0.0-r3`n" +
                     "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n" +
                     "Architecture: ${{ matrix.arch }}`n" +
                     "Features: XML Reader (streaming), DOM, no network, no XPath eval"
        $buildInfo | Out-File -Encoding utf8 -FilePath "$pkgName\BUILD_INFO.txt"
        
        Write-Host "=== Package Contents ==="
        Get-ChildItem "$pkgName" -Recurse | Select-Object FullName, Length
        
        # æ‰“åŒ…
        7z a "${pkgName}.7z" "$pkgName\" -mx=9
        Compress-Archive -Path "$pkgName" -DestinationPath "${pkgName}.zip" -CompressionLevel Optimal

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # ğŸ”§ ä¿®å¤ï¼šåˆ›å»º tag çš„æ­¥éª¤éœ€è¦åœ¨æœ¬ job ä¸­ï¼Œè€Œä¸æ˜¯ä¾èµ– env.RELEASE_TAG
    - name: Create Tag for Manual Release
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
      shell: bash
      id: create_tag  # ğŸ”§ æ·»åŠ  id ä»¥ä¾¿åç»­å¼•ç”¨
      run: |
        TAG_NAME="libxml-minimal-$(date +%Y%m%d-%H%M%S)"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Created tag: $TAG_NAME"

    # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ steps.create_tag.outputs.tag_name è€Œä¸æ˜¯ env.RELEASE_TAG
    - name: Determine Release Tag
      id: get_tag
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.create_release }}" == "true" ]; then
          # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨åˆšåˆ›å»ºçš„ tag
          echo "tag_name=${{ steps.create_tag.outputs.tag_name }}" >> $GITHUB_OUTPUT
        else
          # tag è§¦å‘ï¼šä½¿ç”¨å½“å‰ ref
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: libxml2-2.9.3-minimal-*-gcc93-sjlj
        merge-multiple: true

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
          Get-FileHash -Algorithm SHA256 | 
          ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
          Out-File -Encoding utf8 $checksumFile
        $content = (Get-Content $checksumFile -Raw).Trim()
        "content<<EOF`n$content`nEOF" | Out-File -Append $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ steps.get_tag.outputs.tag_name è€Œä¸æ˜¯ env.RELEASE_TAG
        tag_name: ${{ steps.get_tag.outputs.tag_name }}
        name: Minimal libxml2 ${{ env.LIBXML_VERSION }} Windows (GCC 9.3 SJLJ) ${{ steps.get_tag.outputs.tag_name }}
        body: |
          ## ç²¾ç®€ç‰ˆ libxml2 2.9.3 Windows é™æ€åº“ (GCC 9.3 SJLJ) - æ–¹æ¡ˆB
          
          **ä¿ç•™ XmlTextReader æµå¼ API**ï¼Œé€‚åˆå¤§æ–‡ä»¶å¤„ç†ï¼Œæ— ç½‘ç»œåŠŸèƒ½ã€‚
          
          ### ç¼–è¯‘å™¨ä¿¡æ¯
          - **ç‰ˆæœ¬**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **å¼‚å¸¸å¤„ç†**: SJLJ (SetJump/LongJump)
          - **æ¶æ„**: x86 / x64
          
          ### åŠŸèƒ½è£å‰ªè¯´æ˜
          **å·²ç§»é™¤ï¼ˆå‡å°ä½“ç§¯ï¼Œæé«˜å®‰å…¨æ€§ï¼‰:**
          - âŒ HTTP/FTP ç½‘ç»œå®¢æˆ·ç«¯ä»£ç 
          - âŒ XML Schema/RelaxNG éªŒè¯
          - âŒ XInclude æ–‡ä»¶åŒ…å«
          - âŒ Canonical XML (C14N)
          - âŒ XML Catalog æ”¯æŒ
          - âŒ XML Writer API
          - âŒ XPath è¡¨è¾¾å¼æ±‚å€¼ (ä¿ç•™å¤´æ–‡ä»¶ç±»å‹å®šä¹‰ï¼Œè¿è¡Œæ—¶ä¸å¯ç”¨)
          - âŒ XPointer
          - âŒ æ­£åˆ™è¡¨è¾¾å¼ (pattern)
          - âŒ çº¿ç¨‹æ”¯æŒ (threads)
          - âŒ åŠ¨æ€æ¨¡å—åŠ è½½ (modules)
          - âŒ Zlib/LZMA å‹ç¼©æ”¯æŒ
          
          **ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½:**
          - âœ… **XmlTextReader** - æµå¼æ¸¸æ ‡ APIï¼ˆå†…å­˜é«˜æ•ˆï¼Œæ¨èç”¨äºå¤§æ–‡ä»¶ï¼‰
          - âœ… XML/SAX2 è§£æå™¨
          - âœ… DOM Tree æ“ä½œ
          - âœ… æœ¬åœ°æ–‡ä»¶è¯»å†™
          - âœ… å­—ç¬¦ç¼–ç å¤„ç†
          - âœ… HTML è§£æå™¨ (ç®€åŒ–)
          - âœ… åŸºç¡€ DTD éªŒè¯
          
          ### ä½¿ç”¨ç¤ºä¾‹ - Reader API (æµå¼ï¼Œæ¨è)
          ```c
          #include <libxml/xmlreader.h>
          #define LIBXML_STATIC
          
          int main() {
              xmlTextReaderPtr reader = xmlReaderForFile("bigfile.xml", NULL, 0);
              if (reader) {
                  while (xmlTextReaderRead(reader) == 1) {
                      int type = xmlTextReaderNodeType(reader);
                      const xmlChar *name = xmlTextReaderConstName(reader);
                      printf("Node: %s, Type: %d\n", name, type);
                  }
                  xmlFreeTextReader(reader);
              }
              xmlCleanupParser();
              return 0;
          }
          ```
          
          **é“¾æ¥é€‰é¡¹:** `-lxml2 -lws2_32 -luser32`
          
          ### SHA256 æ ¡éªŒå’Œ
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
