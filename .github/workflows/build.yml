name: Build Minimal libxml2 v2.9.2 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'libxml-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  LIBXML_VERSION: 2.9.2

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            mingw_arch: i686
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z  
            cmake_generator: "MinGW Makefiles"
            artifact_name: libxml2-2.9.2-minimal-win32-gcc93-sjlj
            extra_flags: "CFLAGS=-m32 CXXFLAGS=-m32"
            gcc_prefix: i686-w64-mingw32
          - arch: x64
            msystem: MINGW64
            mingw_arch: x86_64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z  
            cmake_generator: "MinGW Makefiles"
            artifact_name: libxml2-2.9.2-minimal-win64-gcc93-sjlj
            extra_flags: ""
            gcc_prefix: x86_64-w64-mingw32

    name: Build Minimal ${{ matrix.arch }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup winlibs Toolchain
      shell: pwsh
      id: setup_toolchain
      run: |
        $url = "${{ matrix.toolchain_url }}"
        Write-Host "Downloading toolchain from: $url"
        
        $toolchainDir = "C:\winlibs"
        New-Item -ItemType Directory -Force -Path $toolchainDir | Out-Null
        
        Invoke-WebRequest -Uri $url -OutFile toolchain.7z
        7z x toolchain.7z -o"$toolchainDir" -y
        
        $mingwDir = if ("${{ matrix.arch }}" -eq "x86") { "mingw32" } else { "mingw64" }
        $gccPrefix = if ("${{ matrix.arch }}" -eq "x86") { "i686-w64-mingw32" } else { "x86_64-w64-mingw32" }
        $gccExe = Join-Path $toolchainDir "$mingwDir\bin\$gccPrefix-gcc.exe"
        
        if (-not (Test-Path $gccExe)) {
          Write-Error "GCC not found at expected path: $gccExe"
          Get-ChildItem -Path (Join-Path $toolchainDir $mingwDir) -Recurse -Filter "*.exe" | Select-Object -First 10
          exit 1
        }
        
        Write-Host "Found GCC at: $gccExe"
        
        $binPath = Join-Path $toolchainDir "$mingwDir\bin"
        Add-Content -Path $env:GITHUB_PATH -Value $binPath
        
        Add-Content -Path $env:GITHUB_OUTPUT -Value "winlibs_path=$binPath"
        Add-Content -Path $env:GITHUB_OUTPUT -Value "gcc_prefix=$gccPrefix"

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          make

    - name: Download libxml2 Source
      shell: msys2 {0}
      run: |
        curl -L -o libxml2.tar.gz "https://github.com/GNOME/libxml2/archive/refs/tags/v2.9.2.tar.gz"
        tar -xzf libxml2.tar.gz
        ls -la
        find . -maxdepth 2 -type d -name "libxml2*" | head -5

    - name: Configure and Build Minimal libxml2
      shell: msys2 {0}
      run: |
        export WINLIBS_BIN="${{ steps.setup_toolchain.outputs.winlibs_path }}"
        export GCC_PREFIX="${{ steps.setup_toolchain.outputs.gcc_prefix }}"
        
        WINLIBS_MSYS=$(cygpath -u "$WINLIBS_BIN")
        export PATH="$WINLIBS_MSYS:$PATH"
        
        echo "=== Compiler Check ==="
        which ${GCC_PREFIX}-gcc || { echo "GCC not found!"; exit 1; }
        which ar || { echo "AR not found!"; exit 1; }
        ${GCC_PREFIX}-gcc --version | head -2
        
        cd libxml2-2.9.2
        
        echo "=== Generating config.h ==="
        cat > config.h << 'CONFIGH_EOF'
#define PACKAGE "libxml2"
#define VERSION "2.9.2"
#define LIBXML_VERSION 20902
#define LIBXML_VERSION_STRING "2.9.2"
#define HAVE_CTYPE_H 1
#define HAVE_STDLIB_H 1
#define HAVE_MALLOC_H 1
#define HAVE_TIME_H 1
#define HAVE_FCNTL_H 1
#define HAVE_MATH_H 1
#define HAVE_STAT_H 1
#define HAVE__STAT 1
#define HAVE__STATI64 1
#define HAVE__FSTATI64 1
#define HAVE_VSNPRINTF 1
#define HAVE__VSNPRINTF 1
#define HAVE_SNPRINTF 1
#define HAVE_STRICMP 1
#define HAVE_STRDUP 1
#define HAVE_STRNDUP 1
#define HAVE_STRERROR 1
#define HAVE_FINITE 1
#define HAVE_ISNAN 1
#define HAVE_ISINF 1
#define HAVE_LOCALTIME 1
#define HAVE_GMTIME 1
#define HAVE_GETTIMEOFDAY 1
#define HAVE_FTIME 1
#define HAVE_TIME 1
#define HAVE_RAND 1
#define HAVE_SRAND 1
#define HAVE_GETENV 1
#define HAVE_PUTENV 1
#define HAVE_UNLINK 1
#define WITHOUT_HTTP 1
#define WITHOUT_FTP 1
#define WITHOUT_C14N 1
#define WITHOUT_CATALOG 1
#define WITHOUT_DOCB 1
#define WITHOUT_EXPR 1
#define WITHOUT_ICONV 1
#define WITHOUT_ICU 1
#define WITHOUT_ISO8859X 1
#define WITHOUT_PATTERN 1
#define WITHOUT_PUSH 1
#define WITHOUT_PYTHON 1
#define WITHOUT_REGEXPS 1
#define WITHOUT_SCHEMAS 1
#define WITHOUT_SCHEMATRON 1
#define WITHOUT_THREADS 1
#define WITHOUT_THREAD_ALLOC 1
#define WITHOUT_XINCLUDE 1
#define WITHOUT_XPTR 1
#define WITHOUT_MODULES 1
#define WITHOUT_WRITER 1
#define WITHOUT_ZLIB 1
#define WITHOUT_LZMA 1
#define LIBXML_READER_ENABLED 1
#define _CRT_SECURE_NO_DEPRECATE 1
#define _CRT_NONSTDC_NO_DEPRECATE 1
#define WIN32 1
#define _WINDOWS 1
#define SIZEOF_INT 4
#define SIZEOF_LONG 4
#define SIZEOF_LONG_LONG 8
#if defined(_WIN64)
#define SIZEOF_VOIDP 8
#else
#define SIZEOF_VOIDP 4
#endif
#define XML_STATIC 1
#define LIBXML_STATIC 1
#define WITHOUT_TRIO 1
CONFIGH_EOF
        
        echo "=== Copying custom Makefile ==="
        WORKSPACE_MSYS=$(cygpath -u "${{ github.workspace }}")
        cp "$WORKSPACE_MSYS/.github/workflows/libxml2-minimal.mingw" win32/Makefile
        
        cd win32
        
        export EXTRA_FLAGS="${{ matrix.extra_flags }} -DNDEBUG"
        export PREFIX=$(cygpath -u "$PWD/../install")
        
        echo "=== Building ==="
        make clean 2>/dev/null || true
        make -j$(nproc)
        
        echo "=== Build output ==="
        ls -lh *.a
        
        mkdir -p ../install/lib ../install/include/libxml
        cp libxml2.a ../install/lib/
        
        cd ..
        cp include/libxml/*.h install/include/libxml/
        cp config.h install/include/libxml/
        
        rm -f install/include/libxml/nanoftp.h
        rm -f install/include/libxml/nanohttp.h
        rm -f install/include/libxml/catalog.h
        rm -f install/include/libxml/xpointer.h
        rm -f install/include/libxml/schemasInternals.h
        rm -f install/include/libxml/xmlschemas.h
        rm -f install/include/libxml/xmlschemastypes.h
        rm -f install/include/libxml/schematron.h
        rm -f install/include/libxml/relaxng.h
        rm -f install/include/libxml/xmlwriter.h
        rm -f install/include/libxml/c14n.h
        rm -f install/include/libxml/xinclude.h
        
        echo "=== Installed files ==="
        find install -type f | head -20

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        New-Item -ItemType Directory -Force -Path "$pkgName\lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "$pkgName\include\libxml" | Out-Null
        
        $libSource = "libxml2-2.9.2\install\lib"
        if (Test-Path $libSource) {
          Get-ChildItem -Path $libSource -Filter "*.a" | ForEach-Object {
            Copy-Item $_.FullName -Destination "$pkgName\lib\" -Force
          }
        }
        
        if (-not (Test-Path "$pkgName\lib\*.a")) {
          Get-ChildItem -Path "libxml2-2.9.2\win32" -Filter "*.a" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName -Destination "$pkgName\lib\" -Force
          }
        }
        
        $includeSource = "libxml2-2.9.2\install\include"
        if (Test-Path $includeSource) {
          Copy-Item "$includeSource\*" -Destination "$pkgName\" -Recurse -Force
        }
        
        $configInfo = @"
Minimal libxml2 Configuration - Scheme B (Reader API Enabled)

Compile Options:
- Version: 2.9.2
- Compiler: MinGW-w64 GCC 9.3.0 (SJLJ)
- Architecture: ${{ matrix.arch }}

Disabled Features:
- HTTP/FTP network support
- XML Schema/RelaxNG validation
- XInclude file inclusion
- Canonical XML (C14N)
- XML Catalog support
- XML Writer API
- XPath expression evaluation (headers only)
- XPointer
- Regular expression support
- Thread support
- Dynamic module loading
- Zlib/LZMA compression

Enabled Core Features:
- XmlTextReader (streaming cursor API)
- XML/SAX2 parser
- DOM Tree operations
- Local file I/O
- Character encoding conversion
- HTML parser (simplified)
- Basic DTD validation

Link Options:
-lxml2 -lws2_32 -luser32
"@
        
        $configInfo | Out-File -Encoding utf8 -FilePath "$pkgName\CONFIG.txt"
        
        $buildInfo = "Minimal libxml2 ${{ env.LIBXML_VERSION }} ${{ matrix.arch }}`n" +
                     "Compiler: MinGW-w64 GCC 9.3.0 (SJLJ)`n" +
                     "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n" +
                     "Features: XML Reader (streaming), DOM, no network"
        $buildInfo | Out-File -Encoding utf8 -FilePath "$pkgName\BUILD_INFO.txt"
        
        Write-Host "=== Package Contents ==="
        Get-ChildItem "$pkgName" -Recurse | Select-Object FullName, Length
        
        7z a "${pkgName}.7z" "$pkgName\" -mx=9
        Compress-Archive -Path "$pkgName" -DestinationPath "${pkgName}.zip" -CompressionLevel Optimal

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Create Tag for Manual Release
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
      shell: bash
      id: create_tag
      run: |
        TAG_NAME="libxml-minimal-$(date +%Y%m%d-%H%M%S)"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

    - name: Determine Release Tag
      id: get_tag
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.create_release }}" == "true" ]; then
          echo "tag_name=${{ steps.create_tag.outputs.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: libxml2-2.9.2-minimal-*-gcc93-sjlj
        merge-multiple: true

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
          Get-FileHash -Algorithm SHA256 | 
          ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
          Out-File -Encoding utf8 $checksumFile
        $content = (Get-Content $checksumFile -Raw).Trim()
        "content<<EOF`n$content`nEOF" | Out-File -Append $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.tag_name }}
        name: Minimal libxml2 ${{ env.LIBXML_VERSION }} Windows (GCC 9.3 SJLJ) ${{ steps.get_tag.outputs.tag_name }}
        body: |
          ## Minimal libxml2 2.9.2 Windows Static Library (GCC 9.3 SJLJ)
          
          **XmlTextReader streaming API enabled**, no network functions.
          
          ### Compiler Info
          - Version: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - Exception: SJLJ (SetJump/LongJump)
          - Architectures: x86 / x64
          
          ### Features
          **Removed:**
          - HTTP/FTP network client
          - XML Schema/RelaxNG validation
          - XInclude file inclusion
          - Canonical XML (C14N)
          - XML Catalog support
          - XML Writer API
          - XPath expression evaluation
          - XPointer
          - Regular expressions
          - Thread support
          - Dynamic module loading
          - Zlib/LZMA compression
          
          **Kept:**
          - XmlTextReader (streaming cursor API)
          - XML/SAX2 parser
          - DOM Tree operations
          - Local file I/O
          
          **Link:** `-lxml2 -lws2_32 -luser32`
          
          ### SHA256 Checksums
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
